# A Developer's Guide to the `gas-fakes` CLI

## Introduction

The `gas-fakes` library is a powerful tool for safely executing Google Apps Script in a local Node.js environment, functioning as a sandboxed runtime. This is particularly beneficial when running Google Apps Script generated by AI, as it mitigates the security risks associated with the broad permissions that scripts often require. `gas-fakes` enhances security by emulating the Apps Script environment through the translation of GAS service calls into their equivalent, underlying Google API requests, which allows for more granular and file-specific permission controls.

Until now, `gas-fakes` has primarily been used as a library within Node.js scripts. Recognizing the potential for broader application and improved developer experience, a command-line interface (CLI) tool has been created. This CLI tool simplifies the use of `gas-fakes` and can also be used as an MCP (Model Context Protocol) server. This functionality is motivated by the idea that it will enhance its application, especially for tasks like conversational automation of Google Workspace when integrated with tools like the Gemini CLI.

## Getting Started

### 1. Installation

To install the `gas-fakes` CLI tool, run the following command in your terminal:

```bash
npm install -g @mcpher/gas-fakes
```

### 2. Authentication

After installation, you will need to authorize the tool to access your Google account. Detailed instructions for setting up authentication can be found in the official documentation: [Getting Started - Step 2: Set up authentication](https://github.com/brucemcpherson/gas-fakes/blob/main/GETTING_STARTED.md#step-2-set-up-authentication-shells-and-environment).

## Basic Usage

### Displaying Help

To see the available commands and options, run `gas-fakes` with no arguments:

```bash
gas-fakes --help
```

This will display the following help message:

```
$ gas-fakes --help
Usage: gas-fakes [options] [command]

Execute a Google Apps Script file or string.

Options:
  -v, --version                             Display the current version
  -f, --filename <string>                   Path to the Google Apps Script file.
  -s, --script <string>                     A string containing the Google Apps Script.
  -e, --env <path>                          Path to a custom .env file. (default: "./.env")
  -g, --gfsettings <path>                   Path to a gasfakes.json settings file. (default: "./gasfakes.json")
  -x, --sandbox                             Run the script in a basic sandbox.
  -w, --whitelistRead <string>              Comma-separated file IDs for read-only access (enables sandbox).
  --ww, --whitelistReadWrite <string>       Comma-separated file IDs for read/write access (enables sandbox).
  --wt, --whitelistReadWriteTrash <string>  Comma-separated file IDs for read/write/trash access (enables sandbox).
  -j, --json <string>                       JSON string for advanced sandbox configuration (overrides whitelist flags).
  -d, --display                             Display the generated script before execution. (default: false)
  -h, --help                                display help for command

Commands:
  mcp                                       Launch gas-fakes as an MCP server.
```

### Running a Script from a File

You can execute a script from a local file using the `-f` or `--filename` option.

**Example:**

1.  Create a file named `sample1.js` with the following content:

    ```javascript
    const rootFolder = DriveApp.getRootFolder();
    const rootFolderName = rootFolder.getName();
    console.log(rootFolderName);
    ```

2.  Run the following command:

    ```bash
    gas-fakes -f sample1.js
    ```

### Running a Script as a String

For shorter scripts, you can pass the code directly as a string using the `-s` or `--script` option.

**Example:**

```bash
gas-fakes -s "const rootFolder = DriveApp.getRootFolder(); const rootFolderName = rootFolder.getName(); console.log(rootFolderName)"
```

This will produce the same output as the file-based example.

## Sandbox Security

A key feature of `gas-fakes` is its ability to run scripts in a sandbox, which is a restricted environment that prevents the script from accessing unauthorized resources. This is especially important for running code from untrusted sources.

### Enabling the Sandbox

To enable the sandbox, use the `-x` or `--sandbox` option.

**Example:**

```bash
gas-fakes -x -f sample1.js
```

When you run this command, you will see a more verbose output that details the sandbox setup process:

```text
$ gas-fakes -x -f sample1.js
[Worker] ...importing Drive API
[Worker] ...importing Sheets API
[Worker] ...importing Slides API
[Worker] ...didnt find gasfakes.json ... skipping
[Worker] ...didnt find appsscript.json ... skipping
[Worker] ...didnt find .clasp.json ... skipping
[Worker] ...cache will be in /tmp/gas-fakes/cache
[Worker] ...properties will be in /tmp/gas-fakes/properties
[Worker] ...writing to gasfakes.json
[Worker] ...initializing auth and discovering project ID
[Worker] ...discovered and set projectId to for-testing
[Worker] Creating new Drive API client
MyDrive
...trashed 0 sandboxed files
...terminating worker thread
```

### Whitelisting Files in the Sandbox

By default, a sandboxed script cannot access any of your files. To grant access to specific files, you can use the `-w` or `--whitelist` option, providing a comma-separated list of file IDs.

**Example:**

1.  Create a file named `sample2.js` with the following content. Replace `###` with a file ID from your Google Drive.

    ```javascript
    const fileId = "###";
    const file = DriveApp.getFileById(fileId);
    const name = file.getName();
    console.log(name);
    ```

2.  If you run this in a sandbox without whitelisting, you will get an error:

    ```bash
    gas-fakes -x -f sample2.js
    ```

    **Output:**

    ```text
    Error: Access to file ### is denied by sandbox rules
    ```

3.  To grant access, add the file ID to the whitelist:

    ```bash
    gas-fakes -x -f sample2.js -w "###"
    ```

    This time, the script will execute successfully and print the name of the file.

### Advanced Sandbox Control

For more fine-grained control over the sandbox, you can use the `-j` or `--json` option to provide a JSON object that specifies permissions.

**Example:**

Using the same `sample2.js` file, you can define specific permissions for items and services:

```bash
gas-fakes -x -f sample2.js -j '{"whitelistItems":[{"itemId":"###"}],"whitelistServices":[{"className":"DriveApp","methodNames":["getFileById"]}]}'
```

In this example, the sandbox only allows access to the specified file ID (`itemId`) and only permits the use of the `getFileById` method from the `DriveApp` service.

#### JSON Schema for Sandbox Configuration

The JSON object used with the `-j` option follows this schema:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Whitelist and Blacklist Configuration",
  "description": "A configuration for whitelisting and blacklisting items and services.",
  "type": "object",
  "properties": {
    "whitelistItems": {
      "description": "A list of items to be whitelisted.",
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "itemId": {
            "description": "The file ID and folder ID of the file on Google Drive.",
            "type": "string"
          },
          "read": {
            "description": "Read permission for the item. Default is true.",
            "type": "boolean"
          },
          "write": {
            "description": "Write permission for the item. Default is false.",
            "type": "boolean"
          },
          "trash": {
            "description": "Trash permission for the item. Default is false.",
            "type": "boolean"
          }
        },
        "required": ["itemId"]
      }
    },
    "whitelistServices": {
      "description": "A list of services to be whitelisted.",
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "className": {
            "description": "The name of the class of the service.",
            "type": "string"
          },
          "methodNames": {
            "description": "A list of method names for the class to be whitelisted.",
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": ["className"]
      }
    },
    "blacklistServices": {
      "description": "A list of services to be blacklisted.",
      "type": "array",
      "items": {
        "type": "string"
      }
    }
  },
  "required": ["whitelistItems"]
}
```

## Using non default locations

Let's look at this example, where I'm setting a value in a property store unique to the folder Im running from, and using a local .env file, if there is one. Cache stores work in exactly the same way as the property store examples below.

```bash
$ gas-fakes -s "PropertiesService.getScriptProperties().setProperty('hello','world')"
```

I'll see a message like this - in this case i have no .env file in this folder

```bash
...using env file in /Users/brucemcpherson/Documents/repos/gas-fakes/t/.env
...using gasfakes settings file in /Users/brucemcpherson/Documents/repos/gas-fakes/t/gasfakes.json
...etc..
.....PROPERTY store service is using store type FILE as backend
```

Now i can retrieve that value with

```bash
$ gas-fakes -s "console.log(PropertiesService.getScriptProperties().getProperty('hello'))"
...
...PROPERTY store service is using store type FILE as backend
world
```

### Using a different env

Let's say that instead of using the default store type, I want to use redis (see - [sharing cache and properties between gas-fakes and live apps script](https://ramblings.mcpher.com/sharing-cache-and-properties-between-gas-fakes-and-live-apps-script/)), whose details are already defined in some other .env file, I can do this:

```bash
$ gas-fakes -s "PropertiesService.getScriptProperties().setProperty('hello','world of redis')" -e ../.env
...PROPERTY store service is using store type UPSTASH as backend

$ gas-fakes -s "console.log(PropertiesService.getScriptProperties().getProperty('hello'))" -e ../.env
...PROPERTY store service is using store type UPSTASH as backend
world of redis
```

### Using a different gasfakes.json

Similarily, a default gasfakes.json will have generated a random scriptId to use to partition property and cache stores. If you want to share stores between different folders, you need to ensure that the scriptId in gasfkes.json has the same value. This is especially important of you plan to share property and cache stores with live Apps Script (yes you can!). In this case, you set the scriptId in the gasfakes.json to match the scriptId of the live apps script you want to share these stores with.

```bash
$ gas-fakes -s "PropertiesService.getScriptProperties().setProperty('hello','to live apps script')" -e ../.env -g ../test/gasfakes.json
....PROPERTY store service is using store type UPSTASH as backend

$ gas-fakes -s "console.log(PropertiesService.getScriptProperties().getProperty('hello'))" -e ../.env -g ../test/gasfakes.json
...PROPERTY store service is using store type UPSTASH as backend
to live apps script
```

You can find more info about how to read or update these values directly in live apps script using the Dropin replacement for the property and cache stores in [sharing cache and properties between gas-fakes and live apps script](https://ramblings.mcpher.com/sharing-cache-and-properties-between-gas-fakes-and-live-apps-script/)

## MCP

This CLI tool can also be used as the MCP server. Please add the MCP server to `settings.json` as follows.

```json
"mcpServers": {
  "gas-fakes": {
    "command": "gas-fakes",
    "args": ["mcp"]
  }
}
```

When this is used for the Gemini CLI, the following result is obtained.

```
> /mcp

Configured MCP servers:

ðŸŸ¢ gas-fakes - Ready (1 tool)
  Tools:
  - run-gas-by-gas-fakes
```

## <img src="./logo.png" alt="gas-fakes logo" width="50" align="top"> Further Reading

- [getting started](GETTING_STARTED.md) - how to handle authentication for restricted scopes.
- [readme](README.md)
- [initial idea and thoughts](https://ramblings.mcpher.com/a-proof-of-concept-implementation-of-apps-script-environment-on-node/)
- [Inside the volatile world of a Google Document](https://ramblings.mcpher.com/inside-the-volatile-world-of-a-google-document/)
- [Apps Script Services on Node â€“ using apps script libraries](https://ramblings.mcpher.com/apps-script-services-on-node-using-apps-script-libraries/)
- [Apps Script environment on Node â€“ more services](https://ramblings.mcpher.com/apps-script-environment-on-node-more-services/)
- [Turning async into synch on Node using workers](https://ramblings.mcpher.com/turning-async-into-synch-on-node-using-workers/)
- [All about Apps Script Enums and how to fake them](https://ramblings.mcpher.com/all-about-apps-script-enums-and-how-to-fake-them/)
- [Russian version](README.RU.md) ([credit Alex Ivanov](https://github.com/oshliaer)) - needs updating
- [colaborators](collaborators.md) - additional information for collaborators
- [oddities](oddities.md) - a collection of oddities uncovered during this project
- [gemini](gemini.md) - some reflections and experiences on using gemini to help code large projects
- [named colors](named-colors.md)
- [sandbox](sandbox.md)
- [named range identity](named-range-identity.md)
- [adc and restricted scopes](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [push test pull](pull-test-push.md)
- [gas fakes cli](gas-fakes-cli.md)
- [sharing cache and properties between gas-fakes and live apps script](https://ramblings.mcpher.com/sharing-cache-and-properties-between-gas-fakes-and-live-apps-script/)

## <img src="./logo.png" alt="gas-fakes logo" width="50" align="top">  Further Reading

- [getting started](GETTING_STARTED.md) - how to handle authentication for restricted scopes.
- [readme](README.md)
- [initial idea and thoughts](https://ramblings.mcpher.com/a-proof-of-concept-implementation-of-apps-script-environment-on-node/)
- [Inside the volatile world of a Google Document](https://ramblings.mcpher.com/inside-the-volatile-world-of-a-google-document/)
- [Apps Script Services on Node â€“ using apps script libraries](https://ramblings.mcpher.com/apps-script-services-on-node-using-apps-script-libraries/)
- [Apps Script environment on Node â€“ more services](https://ramblings.mcpher.com/apps-script-environment-on-node-more-services/)
- [Turning async into synch on Node using workers](https://ramblings.mcpher.com/turning-async-into-synch-on-node-using-workers/)
- [All about Apps Script Enums and how to fake them](https://ramblings.mcpher.com/all-about-apps-script-enums-and-how-to-fake-them/)
- [Russian version](README.RU.md) ([credit Alex Ivanov](https://github.com/oshliaer)) - needs updating
- [colaborators](collaborators.md) - additional information for collaborators
- [oddities](oddities.md) - a collection of oddities uncovered during this project
- [gemini](gemini-observations.md) - some reflections and experiences on using gemini to help code large projects
- [named colors](named-colors.md)
- [sandbox](sandbox.md)
- [named range identity](named-range-identity.md)
- [adc and restricted scopes](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [push test pull](pull-test-push.md)
- [gas fakes cli](gas-fakes-cli.md)
- [sharing cache and properties between gas-fakes and live apps script](https://ramblings.mcpher.com/sharing-cache-and-properties-between-gas-fakes-and-live-apps-script/)
- [gas-fakes-cli now has built in mcp server and gemini extension](https://ramblings.mcpher.com/gas-fakes-cli-now-has-built-in-mcp-server-and-gemini-extension/)
- [gas-fakes CLI: Run apps script code directly from your terminal](https://ramblings.mcpher.com/gas-fakes-cli-run-apps-script-code-directly-from-your-terminal/)
- [How to allow access to sensitive scopes with Application Default Credentials](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [Supercharge Your Google Apps Script Caching with GasFlexCache](https://ramblings.mcpher.com/supercharge-your-google-apps-script-caching-with-gasflexcache/)
- [Fake-Sandbox for Google Apps Script: Granular controls.](https://ramblings.mcpher.com/fake-sandbox-for-google-apps-script-granular-controls/)
- [A Fake-Sandbox for Google Apps Script: Securely Executing Code Generated by Gemini CLI](https://ramblings.mcpher.com/gas-fakes-sandbox/)