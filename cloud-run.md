# <img src="./logo.png" alt="gas-fakes logo" width="50" align="top">  Running gas-fakes on Google Cloud Run

This guide explains how to containerize and deploy `gas-fakes` tests or applications to Google Cloud Run Jobs. This is useful for long-running tests or scheduled tasks that require the Apps Script environment faked on Node.js. Before starting, make sure you are logged into google cloud using `gcloud auth login` (gas-fakes init should have already automatically done this for you).

## Prerequisites

1.  **Google Cloud Project:** An active GCP project with the Cloud Run, Cloud Build, and **Artifact Registry** APIs enabled.
2.  **Service Account:** This is automatically created and configured when you run `gas-fakes init` (in DWD mode). Ensure you have completed the one-time admin action to enable Domain-Wide Delegation as prompted by the CLI.
3.  **Local Environment:** `gcloud` CLI installed and authenticated.
4.  **Environment Variables:** A `.env` file generated by `gas-fakes init`. The script will use variables like `GOOGLE_SERVICE_ACCOUNT_NAME` and `GOOGLE_CLOUD_PROJECT` already present there.

---

## 1. The Dockerfile

The `Dockerfile` defines the environment. `gas-fakes` mimics the Apps Script environment. In this example, 'cloudrun.js' file is the entry point for the Cloud Run job, and contains the apps script you want to run.

```dockerfile
FROM node:22-slim
WORKDIR /usr/src/app

# 1. Copy project-level package files
COPY package*.json ./
RUN npm install --omit=dev

# 2. Copy the test folder content
COPY . .

# 3. Handle the test-specific dependencies
RUN npm install

# 4. Final setup
# Ensure relative paths to appsscript.json and .env work by staying in the work dir
ENV PORT 8080
EXPOSE 8080

# Execute the entry point
CMD ["node", "cloudrun.js"]
```

### Key Considerations:
*   **Base Image:** `node:22-slim` is recommended for a small footprint.
*   **Work Directory:** Always ensure your `CMD` runs from the directory where your manifest and end entry point are located.

---

## 2. The Cloud Build Configuration (`cloudbuild.yaml`)

Cloud Build uses a `cloudbuild.yaml` file to define the build steps. In this setup, it directs Docker to use the `test/Dockerfile` while maintaining the root of the project as the build context. You should adapt these paths to match your project structure.

```yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-t', '$_IMAGE_PATH', 
      '-f', 'test/Dockerfile', 
      '.'
    ]
images:
  - '$_IMAGE_PATH'
```

*   **Substitutions:** The `$_IMAGE_PATH` is a variable passed from the deployment script.
*   **Context:** The `.` at the end of the build command ensures that the entire project (including parent directories if necessary) is available to the Docker daemon.

---

## 3. The Deployment Script (`deploy-cloudrun.sh`)

Deploying to Cloud Run Jobs requires passing environment variables. Using `--set-env-vars` can be brittle if values contain commas or spaces. The recommended approach is to generate a temporary YAML file. The example script below uses a `.env.yaml` file to store the environment variables and can be modified to your specific needs. The container is deployed as a Cloud Run Job, mimicing the typical Apps Script environment. This means that once deployed, you can run the job as many times as you like either from the gcloud cli or from the Cloud Run console. The section at the end using gcloud alpha run jobs logs tail is optional and will stream the logs to the terminal in real time, and exit on job completion. If you don't need this, then just delete that section.

### Deployment Workflow:

1.  **Load `.env`**: Export variables for local script use.
2.  **Generate `.env.yaml`**: Convert the `.env` format (`KEY=VALUE`) to YAML (`KEY: VALUE`) for `gcloud`.
3.  **Build**: Use Cloud Build to create the container image.
4.  **Deploy/Update**: Use `gcloud run jobs` to create or update the job configuration.
5.  **Execute & Tail**: Start the job and stream logs to the terminal.

### Example Script:

```bash
#!/bin/bash
set -e

# 1. Prepare Environment
ENV_PATH=".env"
ENV_YAML=".env.yaml" # Matches **/.env* in .gitignore for safety

if [ -f "$ENV_PATH" ]; then
    export $(grep -v '^#' "$ENV_PATH" | xargs)
    # Convert .env to YAML using awk for robust de-duplication
    # Define script-specific overrides (separated by |)
    OVERRIDES="GOOGLE_WORKSPACE_SUBJECT=$(gcloud config get-value account)|ANOTHER_VAR=value"

    awk -v overrides="$OVERRIDES" '
        BEGIN { FS="="; OFS=": " }
        /^#/ || /^$/ { next }
        {
            key=$1
            val=substr($0, index($0,"=")+1)
            vars[key]=val
        }
        END {
            split(overrides, ov_list, "|")
            for (i in ov_list) {
                idx = index(ov_list[i], "=")
                if (idx > 0) vars[substr(ov_list[i], 1, idx-1)] = substr(ov_list[i], idx+1)
            }
            for (v in vars) print v, vars[v]
        }
    ' "$ENV_PATH" > "$ENV_YAML"
else
    echo "Error: .env not found" && exit 1
fi

# 2. Build Image
REGION="europe-west1"
JOB_NAME="gas-fakes-job"
REPO_NAME="gas-fakes-repo"
IMAGE_PATH="$REGION-docker.pkg.dev/$GOOGLE_CLOUD_PROJECT/$REPO_NAME/$JOB_NAME"

# Ensure the Artifact Registry repository exists
gcloud artifacts repositories describe "$REPO_NAME" --location="$REGION" >/dev/null 2>&1 || \
    gcloud artifacts repositories create "$REPO_NAME" \
    --repository-format=docker \
    --location="$REGION" \
    --description="Docker repository for gas-fakes"

gcloud builds submit . --config=cloudbuild.yaml --substitutions=_IMAGE_PATH="$IMAGE_PATH"

# 3. Create or Update Job
COMMAND=$(gcloud run jobs describe "$JOB_NAME" --region "$REGION" >/dev/null 2>&1 && echo "update" || echo "create")

gcloud run jobs $COMMAND "$JOB_NAME" \
    --image "$IMAGE_PATH" \
    --region "$REGION" \
    --service-account "${GOOGLE_SERVICE_ACCOUNT_NAME}@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com" \
    --tasks 1 \
    --max-retries 0 \
    --task-timeout 86400 \
    --cpu 1 \
    --memory 2Gi \
    --env-vars-file "$ENV_YAML"

rm "$ENV_YAML"

# 4. Run and Monitor
EXEC_NAME=$(gcloud run jobs execute "$JOB_NAME" --region "$REGION" --format='value(metadata.name)')
echo "--- Execution Started: $EXEC_NAME ---"

# ----- optional section if you want logs to the terminal
# Tail logs in background
gcloud alpha run jobs logs tail "$JOB_NAME" --region "$REGION" &
TAIL_PID=$!

# Kill tail process on script exit
trap "kill $TAIL_PID 2>/dev/null || true" EXIT

# Wait for job completion
echo "--- Waiting for job completion... ---"
while true; do
    FINISHED=$(gcloud run jobs executions describe "$EXEC_NAME" --region "$REGION" --format='value(status.completionTime)' 2>/dev/null || echo "")
    [ -n "$FINISHED" ] && break
    sleep 5
done
echo "--- Job $EXEC_NAME finished ---"
#----- end optional logging section
```

---

## 4. Optimization with `.gcloudignore`

To prevent `gcloud` from uploading large local directories like `node_modules` (which are rebuilt inside the container anyway), create a `.gcloudignore` file in the same directory as your deployment script:

```text
node_modules/
.env*
.env.yaml
private/
*.log
```

This will significantly reduce the time and bandwidth required for the `gcloud builds submit` command.

---

## 5. Security and Identity

*   **Service Account**: `gas-fakes init` creates a service account specifically for your project. This identity is used by Cloud Run to impersonate the `GOOGLE_WORKSPACE_SUBJECT` via Domain-Wide Delegation.
*   **`.gitignore`**: Ensure your temporary YAML file is ignored. Using a prefix like `.env.yaml` and having `**/.env*` in your `.gitignore` is a safe pattern.
*   **Workload Identity**: In Cloud Run, the job automatically uses the attached service account to authenticate with Google APIs, leveraging the `gas-fakes` auth logic.

---

## 6. Troubleshooting

*   **Log Tailing**: If `gcloud run jobs logs tail` is not found, ensure you have the `alpha` or `beta` components installed (`gcloud components install alpha`).
*   **Environment Limits**: Cloud Run has a limit on the number and size of environment variables. If your `.env` is extremely large, consider using Secret Manager.

## <img src="./logo.png" alt="gas-fakes logo" width="50" align="top"> Further Reading

- [getting started](GETTING_STARTED.md) - how to handle authentication for restricted scopes.
- [readme](README.md)
- [gas fakes cli](gas-fakes-cli.md)
- [running gas-fakes on google cloud run](cloud-run.md)
- [initial idea and thoughts](https://ramblings.mcpher.com/a-proof-of-concept-implementation-of-apps-script-environment-on-node/)
- [Inside the volatile world of a Google Document](https://ramblings.mcpher.com/inside-the-volatile-world-of-a-google-document/)
- [Apps Script Services on Node – using apps script libraries](https://ramblings.mcpher.com/apps-script-services-on-node-using-apps-script-libraries/)
- [Apps Script environment on Node – more services](https://ramblings.mcpher.com/apps-script-environment-on-node-more-services/)
- [Turning async into synch on Node using workers](https://ramblings.mcpher.com/turning-async-into-synch-on-node-using-workers/)
- [All about Apps Script Enums and how to fake them](https://ramblings.mcpher.com/all-about-apps-script-enums-and-how-to-fake-them/)
- [colaborators](collaborators.md) - additional information for collaborators
- [oddities](oddities.md) - a collection of oddities uncovered during this project
- [named colors](named-colors.md)
- [sandbox](sandbox.md)
- [using apps script libraries with gas-fakes](libraries.md)
- [how libhandler works](libhandler.md)
- [article:using apps script libraries with gas-fakes](https://ramblings.mcpher.com/how-to-use-apps-script-libraries-directly-from-node/)
- [named range identity](named-range-identity.md)
- [adc and restricted scopes](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [push test pull](pull-test-push.md)
- [sharing cache and properties between gas-fakes and live apps script](https://ramblings.mcpher.com/sharing-cache-and-properties-between-gas-fakes-and-live-apps-script/)
- [gas-fakes-cli now has built in mcp server and gemini extension](https://ramblings.mcpher.com/gas-fakes-cli-now-has-built-in-mcp-server-and-gemini-extension/)
- [gas-fakes CLI: Run apps script code directly from your terminal](https://ramblings.mcpher.com/gas-fakes-cli-run-apps-script-code-directly-from-your-terminal/)
- [How to allow access to sensitive scopes with Application Default Credentials](https://ramblings.mcpher.com/how-to-allow-access-to-sensitive-scopes-with-application-default-credentials/)
- [Supercharge Your Google Apps Script Caching with GasFlexCache](https://ramblings.mcpher.com/supercharge-your-google-apps-script-caching-with-gasflexcache/)
- [Fake-Sandbox for Google Apps Script: Granular controls.](https://ramblings.mcpher.com/fake-sandbox-for-google-apps-script-granular-controls/)
- [A Fake-Sandbox for Google Apps Script: Securely Executing Code Generated by Gemini CLI](https://ramblings.mcpher.com/gas-fakes-sandbox/)
- [Power of Google Apps Script: Building MCP Server Tools for Gemini CLI and Google Antigravity in Google Workspace Automation](https://medium.com/google-cloud/power-of-google-apps-script-building-mcp-server-tools-for-gemini-cli-and-google-antigravity-in-71e754e4b740)
- [A New Era for Google Apps Script: Unlocking the Future of Google Workspace Automation with Natural Language](https://medium.com/google-cloud/a-new-era-for-google-apps-script-unlocking-the-future-of-google-workspace-automation-with-natural-a9cecf87b4c6)
- [Next-Generation Google Apps Script Development: Leveraging Antigravity and Gemini 3.0](https://medium.com/google-cloud/next-generation-google-apps-script-development-leveraging-antigravity-and-gemini-3-0-c4d5affbc1a8)
- [Modern Google Apps Script Workflow Building on the Cloud](https://medium.com/google-cloud/modern-google-apps-script-workflow-building-on-the-cloud-2255dbd32ac3)
- [Bridging the Gap: Seamless Integration for Local Google Apps Script Development](https://medium.com/@tanaike/bridging-the-gap-seamless-integration-for-local-google-apps-script-development-9b9b973aeb02)
- [Next-Level Google Apps Script Development](https://medium.com/google-cloud/next-level-google-apps-script-development-654be5153912)
- [Secure and Streamlined Google Apps Script Development with gas-fakes CLI and Gemini CLI Extension](https://medium.com/google-cloud/secure-and-streamlined-google-apps-script-development-with-gas-fakes-cli-and-gemini-cli-extension-67bbce80e2c8)
- [Secure and Conversational Google Workspace Automation: Integrating Gemini CLI with a gas-fakes MCP Server](https://medium.com/google-cloud/secure-and-conversational-google-workspace-automation-integrating-gemini-cli-with-a-gas-fakes-mcp-0a5341559865)
- [A Fake-Sandbox for Google Apps Script: A Feasibility Study on Securely Executing Code Generated by Gemini CL](https://medium.com/google-cloud/a-fake-sandbox-for-google-apps-script-a-feasibility-study-on-securely-executing-code-generated-by-cc985ce5dae3)
